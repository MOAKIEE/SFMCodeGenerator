<UserControl x:Class="SFMCodeGenerator.Views.VisualEditorView"
             xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:vm="clr-namespace:SFMCodeGenerator.ViewModels"
             Background="#F5F5F5">
    
    <UserControl.Resources>
        <!-- 统一的主色调 -->
        <Color x:Key="MainColor">#5C6BC0</Color>
        <SolidColorBrush x:Key="MainBrush" Color="{StaticResource MainColor}"/>
        <SolidColorBrush x:Key="ArrowColor" Color="#4CAF50"/>

        <!-- 转换器 -->
        <vm:LineEndpointConverter x:Key="LineEndpointConverter"/>
        <vm:LineAngleConverter x:Key="LineAngleConverter"/>
        <vm:CenterConverter x:Key="CenterConverterX" Offset="90"/>
        <vm:CenterConverter x:Key="CenterConverterY" Offset="40"/>
        <vm:ResourceIdListConverter x:Key="ResourceIdListConverter"/>
        
        <!-- 统一按钮样式 -->
        <Style x:Key="MainButton" TargetType="Button">
            <Setter Property="Background" Value="{StaticResource MainBrush}"/>
            <Setter Property="Foreground" Value="White"/>
            <Setter Property="BorderThickness" Value="0"/>
            <Setter Property="Padding" Value="12,6"/>
            <Setter Property="Cursor" Value="Hand"/>
            <Setter Property="FontSize" Value="12"/>
        </Style>
        <Style TargetType="Button" BasedOn="{StaticResource MainButton}"/>
        
        <!-- 浅色 ComboBox 样式 -->
        <Style x:Key="LightComboBox" TargetType="ComboBox">
            <Setter Property="Background" Value="White"/>
            <Setter Property="Foreground" Value="#333"/>
            <Setter Property="BorderBrush" Value="#CCC"/>
            <Setter Property="BorderThickness" Value="1"/>
            <Setter Property="Padding" Value="6,4"/>
        </Style>
        
        <!-- 浅色文本框样式 -->
        <Style x:Key="LightTextBox" TargetType="TextBox">
            <Setter Property="Background" Value="White"/>
            <Setter Property="Foreground" Value="#333"/>
            <Setter Property="BorderBrush" Value="#CCC"/>
            <Setter Property="BorderThickness" Value="1"/>
            <Setter Property="Padding" Value="6,4"/>
        </Style>
    </UserControl.Resources>
    
    <UserControl.DataContext>
        <vm:VisualEditorViewModel/>
    </UserControl.DataContext>
    
    <Grid>
        <Grid.ColumnDefinitions>
            <ColumnDefinition Width="*"/>
            <ColumnDefinition Width="280"/>
        </Grid.ColumnDefinitions>
        
        <!-- 左侧：图形编辑区域 -->
        <Border Grid.Column="0" Background="#FAFAFA" BorderBrush="#E0E0E0" BorderThickness="0,0,1,0">
            <Grid>
                <Grid.RowDefinitions>
                    <RowDefinition Height="Auto"/>
                    <RowDefinition Height="Auto"/>
                    <RowDefinition Height="*"/>
                </Grid.RowDefinitions>
                
                <!-- 触发器选择栏 -->
                <Border Grid.Row="0" Background="#E8E8E8" Padding="12,8">
                    <StackPanel Orientation="Horizontal">
                        <TextBlock Text="触发器:" Foreground="#555" VerticalAlignment="Center" Margin="0,0,8,0"/>
                        <ComboBox ItemsSource="{Binding Triggers}" 
                                  SelectedItem="{Binding SelectedTrigger}"
                                  DisplayMemberPath="Name" Width="100" Style="{StaticResource LightComboBox}"/>
                        <Button Content="+ 新建" Click="AddTrigger_Click" Margin="8,0,0,0"/>
                        <Button Content="删除" Click="RemoveTrigger_Click" Margin="4,0,0,0"/>
                        
                        <TextBlock Text="类型:" Foreground="#555" VerticalAlignment="Center" Margin="20,0,8,0"/>
                        <ComboBox ItemsSource="{x:Static vm:VisualEditorViewModel.TriggerTypes}"
                                  SelectedItem="{Binding SelectedTrigger.TriggerType}" Width="100" 
                                  Style="{StaticResource LightComboBox}"/>
                        
                        <TextBlock Text="频率:" Foreground="#555" VerticalAlignment="Center" Margin="16,0,8,0"/>
                        <TextBox Text="{Binding SelectedTrigger.TickInterval, UpdateSourceTrigger=PropertyChanged}" 
                                 Style="{StaticResource LightTextBox}" Width="50"/>
                        <TextBlock Text="tick" Foreground="#555" VerticalAlignment="Center" Margin="8,0,0,0"/>
                    </StackPanel>
                </Border>
                
                <!-- 节点工具栏 -->
                <Border Grid.Row="1" Background="White" Padding="12,8" BorderBrush="#E0E0E0" BorderThickness="0,0,0,1">
                    <StackPanel Orientation="Horizontal">
                        <Button Content="+ 添加节点" Command="{Binding AddNodeCommand}"/>
                        <TextBlock Text="点击[连接]按钮，再点另一个节点完成连接" 
                                   Foreground="#888" VerticalAlignment="Center" Margin="16,0,0,0"/>
                    </StackPanel>
                </Border>
                
                <!-- 画布区域 -->
                <Canvas x:Name="EditorCanvas" Grid.Row="2" Background="White" ClipToBounds="True"
                        MouseMove="Canvas_MouseMove" MouseLeftButtonUp="Canvas_MouseLeftButtonUp">
                    
                    <!-- 网格背景 -->
                    <Canvas.Resources>
                        <VisualBrush x:Key="GridBrush" TileMode="Tile" 
                                     Viewport="0,0,30,30" ViewportUnits="Absolute">
                            <VisualBrush.Visual>
                                <Rectangle Width="30" Height="30" Stroke="#F0F0F0" StrokeThickness="1"/>
                            </VisualBrush.Visual>
                        </VisualBrush>
                    </Canvas.Resources>
                    <Rectangle Width="{Binding ActualWidth, ElementName=EditorCanvas}" 
                               Height="{Binding ActualHeight, ElementName=EditorCanvas}"
                               Fill="{StaticResource GridBrush}"/>
                    
                    <!-- 连接线和箭头 -->
                    <ItemsControl ItemsSource="{Binding SelectedTrigger.Connections}" Panel.ZIndex="3">
                        <ItemsControl.ItemsPanel>
                            <ItemsPanelTemplate>
                                <Canvas/>
                            </ItemsPanelTemplate>
                        </ItemsControl.ItemsPanel>
                        <ItemsControl.ItemTemplate>
                            <DataTemplate>
                                <Canvas>
                                    <!-- 连接线 -->
                                    <Line Stroke="#4CAF50" StrokeThickness="3">
                                        <Line.X1>
                                            <MultiBinding Converter="{StaticResource LineEndpointConverter}" ConverterParameter="startX">
                                                <Binding Path="Source.X"/>
                                                <Binding Path="Source.Y"/>
                                                <Binding Path="Target.X"/>
                                                <Binding Path="Target.Y"/>
                                            </MultiBinding>
                                        </Line.X1>
                                        <Line.Y1>
                                            <MultiBinding Converter="{StaticResource LineEndpointConverter}" ConverterParameter="startY">
                                                <Binding Path="Source.X"/>
                                                <Binding Path="Source.Y"/>
                                                <Binding Path="Target.X"/>
                                                <Binding Path="Target.Y"/>
                                            </MultiBinding>
                                        </Line.Y1>
                                        <Line.X2>
                                            <MultiBinding Converter="{StaticResource LineEndpointConverter}" ConverterParameter="endX">
                                                <Binding Path="Source.X"/>
                                                <Binding Path="Source.Y"/>
                                                <Binding Path="Target.X"/>
                                                <Binding Path="Target.Y"/>
                                            </MultiBinding>
                                        </Line.X2>
                                        <Line.Y2>
                                            <MultiBinding Converter="{StaticResource LineEndpointConverter}" ConverterParameter="endY">
                                                <Binding Path="Source.X"/>
                                                <Binding Path="Source.Y"/>
                                                <Binding Path="Target.X"/>
                                                <Binding Path="Target.Y"/>
                                            </MultiBinding>
                                        </Line.Y2>
                                    </Line>
                                    
                                    <!-- 箭头 - 使用简单的三角形 -->
                                    <Polygon Points="0,0 -12,6 -12,-6" Fill="#4CAF50" Panel.ZIndex="6">
                                        <Canvas.Left>
                                            <MultiBinding Converter="{StaticResource LineEndpointConverter}" ConverterParameter="endX">
                                                <Binding Path="Source.X"/>
                                                <Binding Path="Source.Y"/>
                                                <Binding Path="Target.X"/>
                                                <Binding Path="Target.Y"/>
                                            </MultiBinding>
                                        </Canvas.Left>
                                        <Canvas.Top>
                                            <MultiBinding Converter="{StaticResource LineEndpointConverter}" ConverterParameter="endY">
                                                <Binding Path="Source.X"/>
                                                <Binding Path="Source.Y"/>
                                                <Binding Path="Target.X"/>
                                                <Binding Path="Target.Y"/>
                                            </MultiBinding>
                                        </Canvas.Top>
                                        <Polygon.RenderTransform>
                                            <RotateTransform>
                                                <RotateTransform.Angle>
                                                    <MultiBinding Converter="{StaticResource LineAngleConverter}">
                                                        <Binding Path="Source.X"/>
                                                        <Binding Path="Source.Y"/>
                                                        <Binding Path="Target.X"/>
                                                        <Binding Path="Target.Y"/>
                                                    </MultiBinding>
                                                </RotateTransform.Angle>
                                            </RotateTransform>
                                        </Polygon.RenderTransform>
                                    </Polygon>
                                    
                                        <!-- 旋转按钮 - 在线的上方 -->
                                        <Button Width="26" Height="26" FontSize="16" Cursor="Hand" 
                                            ToolTip="点击反转方向" Click="ReverseConnection_Click" Tag="{Binding}"
                                            Background="White" BorderBrush="{StaticResource MainBrush}" BorderThickness="1"
                                            Foreground="{StaticResource MainBrush}" Panel.ZIndex="7"
                                            Padding="0" HorizontalContentAlignment="Center" VerticalContentAlignment="Center"
                                            FontFamily="Segoe UI Symbol">
                                        <Button.Content>
                                            <TextBlock Text="↻" FontWeight="Bold" Margin="0,-2,0,0"/>
                                        </Button.Content>
                                        <Canvas.Left>
                                            <MultiBinding>
                                                <MultiBinding.Converter>
                                                    <StaticResource ResourceKey="CenterConverterX"/>
                                                </MultiBinding.Converter>
                                                <Binding Path="Source.X"/>
                                                <Binding Path="Target.X"/>
                                            </MultiBinding>
                                        </Canvas.Left>
                                        <Canvas.Top>
                                            <MultiBinding>
                                                <MultiBinding.Converter>
                                                    <StaticResource ResourceKey="CenterConverterY"/>
                                                </MultiBinding.Converter>
                                                <Binding Path="Source.Y"/>
                                                <Binding Path="Target.Y"/>
                                            </MultiBinding>
                                        </Canvas.Top>
                                    </Button>
                                </Canvas>
                            </DataTemplate>
                        </ItemsControl.ItemTemplate>
                    </ItemsControl>
                    
                    <!-- 正在绘制的临时连接线（带箭头效果） -->
                      <Line x:Name="TempConnectionLine" Stroke="#4CAF50" StrokeThickness="3" 
                          Visibility="Collapsed" Panel.ZIndex="2"/>
                    
                    <!-- 节点 -->
                    <ItemsControl ItemsSource="{Binding SelectedTrigger.Nodes}" Panel.ZIndex="2">
                        <ItemsControl.ItemsPanel>
                            <ItemsPanelTemplate>
                                <Canvas/>
                            </ItemsPanelTemplate>
                        </ItemsControl.ItemsPanel>
                        <ItemsControl.ItemContainerStyle>
                            <Style>
                                <Setter Property="Canvas.Left" Value="{Binding X}"/>
                                <Setter Property="Canvas.Top" Value="{Binding Y}"/>
                            </Style>
                        </ItemsControl.ItemContainerStyle>
                        <ItemsControl.ItemTemplate>
                            <DataTemplate>
                                <Border Background="White" CornerRadius="8" 
                                        Padding="12,10" Cursor="Hand" MinWidth="180"
                                        BorderBrush="#DDD" BorderThickness="1"
                                        MouseLeftButtonDown="Node_MouseLeftButtonDown"
                                        MouseMove="Node_MouseMove"
                                        MouseLeftButtonUp="Node_MouseLeftButtonUp">
                                    <Border.Effect>
                                        <DropShadowEffect BlurRadius="8" ShadowDepth="2" Opacity="0.15" Color="Black"/>
                                    </Border.Effect>
                                    <StackPanel>
                                        <TextBlock Text="{Binding DisplayName}" 
                                                   Foreground="#333" FontWeight="Bold" FontSize="14" Margin="0,0,0,8"/>
                                        
                                        <!-- 标签 -->
                                        <Grid Margin="0,2">
                                            <Grid.ColumnDefinitions>
                                                <ColumnDefinition Width="50"/>
                                                <ColumnDefinition Width="*"/>
                                            </Grid.ColumnDefinitions>
                                            <TextBlock Text="标签:" Foreground="#666" VerticalAlignment="Center"/>
                                            <ComboBox Grid.Column="1"
                                                      Text="{Binding Label, UpdateSourceTrigger=PropertyChanged}"
                                                      ItemsSource="{Binding DataContext.CommonLabels, RelativeSource={RelativeSource AncestorType=UserControl}}"
                                                      IsEditable="True" Style="{StaticResource LightComboBox}"/>
                                        </Grid>
                                        
                                        <!-- 方向 -->
                                        <Grid Margin="0,2">
                                            <Grid.ColumnDefinitions>
                                                <ColumnDefinition Width="50"/>
                                                <ColumnDefinition Width="*"/>
                                            </Grid.ColumnDefinitions>
                                            <TextBlock Text="方向:" Foreground="#666" VerticalAlignment="Center"/>
                                            <ComboBox Grid.Column="1" ItemsSource="{x:Static vm:VisualNode.SideOptions}"
                                                      SelectedItem="{Binding Side}" Style="{StaticResource LightComboBox}"/>
                                        </Grid>
                                        
                                        <!-- 类型 -->
                                        <Grid Margin="0,2">
                                            <Grid.ColumnDefinitions>
                                                <ColumnDefinition Width="50"/>
                                                <ColumnDefinition Width="*"/>
                                            </Grid.ColumnDefinitions>
                                            <TextBlock Text="类型:" Foreground="#666" VerticalAlignment="Center"/>
                                            <ComboBox Grid.Column="1" ItemsSource="{x:Static vm:VisualNode.TypeOptions}"
                                                      SelectedItem="{Binding ResourceType}" Style="{StaticResource LightComboBox}"/>
                                        </Grid>
                                        
                                        <!-- 资源ID -->
                                        <Grid Margin="0,2">
                                            <Grid.ColumnDefinitions>
                                                <ColumnDefinition Width="50"/>
                                                <ColumnDefinition Width="*"/>
                                            </Grid.ColumnDefinitions>
                                            <TextBlock Text="ID:" Foreground="#666" VerticalAlignment="Center"/>
                                            <ComboBox Grid.Column="1"
                                                      Text="{Binding ResourceId, UpdateSourceTrigger=PropertyChanged}"
                                                      IsEditable="True" Style="{StaticResource LightComboBox}">
                                                <ComboBox.ItemsSource>
                                                    <MultiBinding Converter="{StaticResource ResourceIdListConverter}">
                                                        <Binding Path="ResourceType"/>
                                                        <Binding Path="DataContext.CommonItemIds" RelativeSource="{RelativeSource AncestorType=UserControl}"/>
                                                        <Binding Path="DataContext.CommonFluidIds" RelativeSource="{RelativeSource AncestorType=UserControl}"/>
                                                        <Binding Path="DataContext.CommonEnergyIds" RelativeSource="{RelativeSource AncestorType=UserControl}"/>
                                                        <Binding Path="DataContext.CommonGasIds" RelativeSource="{RelativeSource AncestorType=UserControl}"/>
                                                    </MultiBinding>
                                                </ComboBox.ItemsSource>
                                            </ComboBox>
                                        </Grid>
                                        
                                        <!-- 数量 -->
                                        <Grid Margin="0,2">
                                            <Grid.ColumnDefinitions>
                                                <ColumnDefinition Width="50"/>
                                                <ColumnDefinition Width="*"/>
                                            </Grid.ColumnDefinitions>
                                            <TextBlock Text="数量:" Foreground="#666" VerticalAlignment="Center"/>
                                            <TextBox Grid.Column="1" Text="{Binding Quantity, UpdateSourceTrigger=PropertyChanged}" 
                                                     Style="{StaticResource LightTextBox}"/>
                                        </Grid>
                                        
                                        <!-- 操作按钮 -->
                                        <StackPanel Orientation="Horizontal" Margin="0,8,0,0">
                                            <Button Content="连接" Margin="0,0,4,0"
                                                    Click="StartConnection_Click" Tag="{Binding}"/>
                                            <Button Content="删除"
                                                    Command="{Binding DataContext.RemoveNodeCommand, RelativeSource={RelativeSource AncestorType=UserControl}}"
                                                    CommandParameter="{Binding}"/>
                                        </StackPanel>
                                    </StackPanel>
                                </Border>
                            </DataTemplate>
                        </ItemsControl.ItemTemplate>
                    </ItemsControl>
                    
                    <!-- 提示文字 -->
                    <TextBlock Canvas.Left="20" Canvas.Top="20" 
                               Text="拖拽移动节点 | 点击[连接]开始 -> 点击目标节点完成 | 绿色箭头表示数据流向" 
                               Foreground="#AAA" FontSize="12"/>
                </Canvas>
            </Grid>
        </Border>
        
        <!-- 右侧：代码预览 -->
        <Border Grid.Column="1" Background="White">
            <Grid Margin="16">
                <Grid.RowDefinitions>
                    <RowDefinition Height="Auto"/>
                    <RowDefinition Height="*"/>
                    <RowDefinition Height="Auto"/>
                </Grid.RowDefinitions>
                
                <TextBlock Grid.Row="0" Text="生成的代码" 
                           Foreground="#333" FontSize="16" FontWeight="Bold" Margin="0,0,0,12"/>
                
                <TextBox Grid.Row="1" Text="{Binding GeneratedCode, Mode=OneWay}" 
                         IsReadOnly="True" VerticalScrollBarVisibility="Auto"
                         Background="#F8F8F8" Foreground="#333" FontFamily="Consolas"
                         BorderBrush="#DDD" BorderThickness="1" Padding="8"/>
                
                <Button Grid.Row="2" Content="复制代码"
                        Command="{Binding CopyCodeCommand}" Margin="0,12,0,0" Padding="16,10" FontSize="14"/>
            </Grid>
        </Border>
    </Grid>
</UserControl>
